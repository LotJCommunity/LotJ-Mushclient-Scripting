<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Friday, February 15, 2019, 8:16 AM -->
<!-- MuClient version 4.94 -->

<!-- Plugin "LotJ_SpaceInfobar" generated by Plugin Wizard -->

<muclient>
<plugin
   name="LotJ_SpaceInfobar"
   author="@Fishy"
   id="18900f8b58e30acf22a781bb"
   language="Lua"
   purpose="Simple info bar for space"
   save_state="y"
   date_written="2019-02-15 08:15:06"
   requires="4.94"
   version="1.01"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<aliases>
  <alias
   enabled = "y"
   script="ToggleShowInfo"
   match="spaceinfo"
   sequence="100"
  >
  </alias>
</aliases>


<script>
<![CDATA[ 

require "checkplugin"

local showSpaceInfo = false
local piloting
local player_shields
local player_energy
local player_hull
local player_speed
local playerpos = {x = nil, y = nil, z = nil}
local sys_info = {name = nil, x = nil, y = nil}

InfoClear()
InfoBackground("lightgray")
ShowInfoBar(false)

function OnPluginListChanged()
    do_plugin_check_now ("b3aae34498d5bf19b5b2e2af", "LotJMSDPHandler") -- check we have MSDP handler plugin
end

function loadluafile(filename)
    f, err = loadfile (GetPluginInfo(GetPluginID(), 20) .. filename)
    if (f == nil) then
        -- This is the error we get when we fail the plugin check.  So, copying that error here
        ColourNote("black","red","--------------------------------------------------------------------------------")
        ColourNote("black","red","Unable to load file '"..filename.."'.  Please download and install it.")
        ColourNote("black","red","It is required for the correct operation of the "..GetPluginInfo (GetPluginID (), 1).." plugin.")
        ColourNote("black","red","File error:")
        ColourNote("black","red",err)
        ColourNote("black","red","--------------------------------------------------------------------------------")
        EnablePlugin("63e6909083318cf63707c044", false)
        ColourNote("red","black","Plugin disabled.")
    else
        f()
    end
end

loadluafile ("LotJMSDPHelper.lua") -- part of the MSDP handler plugin, we need this too

function UpdateVariables()
	player_energy = getmsdp("SHIPENERGY")
	player_shields = getmsdp("SHIPSHIELD")
	player_hull = getmsdp("SHIPHULL")
	player_speed = getmsdp("SHIPSPEED")
	playerpos.x = getmsdp("SHIPSYSX")
	playerpos.y = getmsdp("SHIPSYSY")
	playerpos.z = getmsdp("SHIPSYSZ")
	sys_info.name = getmsdp("SHIPSYSNAME")
	sys_info.x = getmsdp("SHIPGALX")
	sys_info.y = getmsdp("SHIPGALY")
	if (getmsdp("PILOTING") == "1") then piloting = true else piloting = false end
end

function ToggleShowInfo()
	showSpaceInfo = not showSpaceInfo
	Note(showSpaceInfo and "Space Infobar Enabled" or "Space Infobar Disabled")
	ShowInfoBar(showSpaceInfo)
	UpdateInfo()
end

function UpdateInfo()
	if(showSpaceInfo) then
		UpdateVariables()
		ShowInfoBar(true)
		InfoClear()
		InfoBackground("lightgray")
		InfoFont ("Arial", 9, 0)
		Info("  Shields:", player_shields, "     Energy:", player_energy,"     Hull:", player_hull,"     Speed:",player_speed,"     Coords: ",playerpos.x,", ",playerpos.y,", ",playerpos.z,  "     ",sys_info.name, " (",sys_info.x, ", ",sys_info.y,")")
		InfoFont ("Arial", 9, 1)
		Info((piloting and "     P" or ""))
	end
end

function OnPluginBroadcast (msg, id, name, text)
	if (id == "b3aae34498d5bf19b5b2e2af") then -- if msdphandler plugin is broadcasting an update
	-- check to see if the text refers to a space-related msdpvar
		if (text == "PILOTING") then
			if (getmsdp(text) == "1") then piloting = true else piloting = false end
			UpdateInfo()
		end
		if ( string.find(text, "SHIP")) then 
		
			if (text == "SHIPGALX") then sys_info.x = getmsdp(text) end
			if (text == "SHIPGALY") then sys_info.y = getmsdp(text) end
			if (text == "SHIPSYSNAME") then
				-- Sysname is blank with positions of 0,0 for hyperspace/landed.
				-- Sysname is "uncharted space" or some shit in uncharted, go figure.
				sys_info.name = getmsdp(text)
			end

			if (text == "SHIPSPEED") then
				player_speed = getmsdp(text)
			end
			
			if (string.find(text, "SHIPSYS")) then
				if (text == "SHIPSYSX") then
					playerpos.x = getmsdp(text)
				end
				if (text == "SHIPSYSY") then
					playerpos.y = getmsdp(text)
				end
				if (text == "SHIPSYSZ") then
					playerpos.z = getmsdp(text)
				end
			end
				
			
			if (text == "SHIPENERGY") then
				player_energy = getmsdp(text)
			end
			
			if (text == "SHIPSHIELD") then
				player_shields = getmsdp(text)
			end
			
			if (text == "SHIPHULL") then
				player_hull = getmsdp(text)
			end
		UpdateInfo()
		
		end
	end
end
]]>
</script>

</muclient>
